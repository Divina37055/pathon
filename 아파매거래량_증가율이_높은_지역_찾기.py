# -*- coding: utf-8 -*-
"""ì•„íŒŒë§¤ê±°ë˜ëŸ‰ ì¦ê°€ìœ¨ì´ ë†’ì€ ì§€ì—­ ì°¾ê¸°

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ehIJGYAqPr4zJcvtmt2gyaAcZ9Ue_4uN
"""

import pandas as pd
from pathlib import Path
from datetime import datetime, timedelta

# ==============================================================================
# 1. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì •ì˜: ì›” ê³„ì‚° ë° ì»¬ëŸ¼ëª… í˜•ì‹ ì§€ì •
# ==============================================================================

def get_month_string(year, month):
    """'YYYYë…„ Mì›”' í˜•íƒœì˜ ë¬¸ìì—´ì„ ë°˜í™˜ (íŒŒì¼ ì»¬ëŸ¼ëª…ê³¼ ì¼ì¹˜í•˜ë„ë¡ '0' ì œê±°)."""
    # 1~9ì›”ì— '0'ì´ ë¶™ì§€ ì•Šë„ë¡ í¬ë§·íŒ…ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
    return f"{year}ë…„ {month}ì›”"

def get_previous_month(year, month):
    """ì…ë ¥ëœ ë…„/ì›”ì˜ ì´ì „ ë‹¬ì˜ ë…„/ì›”ì„ ê³„ì‚°í•˜ì—¬ ë°˜í™˜."""
    if month == 1:
        return year - 1, 12
    else:
        return year, month - 1

def get_analysis_months(target_year, target_month):
    """
    ë¶„ì„ì— í•„ìš”í•œ 4ê°œ ì›”(íƒ€ê²Ÿ ì›”ê³¼ ê·¸ ì´ì „ 3ê°œì›”)ì˜ ë…„/ì›” íŠœí”Œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    """
    month_list = []
    y, m = target_year, target_month

    # ì´ 4ê°œì˜ ì›”ì„ ì—­ìˆœìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤. (íƒ€ê²Ÿ ì›”ë¶€í„° ì‹œì‘)
    for _ in range(4):
        month_list.append((y, m))
        y, m = get_previous_month(y, m)

    return month_list[::-1] # ê°€ì¥ ì˜¤ë˜ëœ ë‹¬ë¶€í„° ìˆœì„œëŒ€ë¡œ ì •ë ¬í•˜ì—¬ ë°˜í™˜

# ==============================================================================
# 2. ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
# ==============================================================================

print("## ğŸ“Š ë¶„ì„ì„ ì›í•˜ëŠ” ê¸°ì¤€ ì›”ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
while True:
    try:
        input_year = int(input("ë¶„ì„ ê¸°ì¤€ ë…„ë„ (YYYY): "))
        input_month = int(input("ë¶„ì„ ê¸°ì¤€ ì›” (MM): "))
        if 1 <= input_month <= 12:
            break
        else:
            print("âŒ ì›”ì€ 1ë¶€í„° 12 ì‚¬ì´ì˜ ê°’ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    except ValueError:
        print("âŒ ë…„ë„ì™€ ì›”ì„ ìˆ«ìë¡œ ì •í™•í•˜ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# ë¶„ì„ì— í•„ìš”í•œ 4ê°œ ì›”ì˜ (ë…„, ì›”) íŠœí”Œ ë¦¬ìŠ¤íŠ¸ ìƒì„±
analysis_months_tuple = get_analysis_months(input_year, input_month)
# ì»¬ëŸ¼ëª…ì— ì‚¬ìš©í•  'YYYYë…„ Mì›”' ë¬¸ìì—´ ë¦¬ìŠ¤íŠ¸ ìƒì„±
analysis_month_names = [get_month_string(y, m) for y, m in analysis_months_tuple]

print(f"\nâœ… ë¶„ì„ ëŒ€ìƒ ê¸°ê°„: {analysis_month_names[0]}ë¶€í„° {analysis_month_names[-1]}ê¹Œì§€ (4ê°œì›” ë°ì´í„° í•„ìš”)")


# ==============================================================================
# 3. íŒŒì¼ ë¡œë“œ (ê°€ì¥ ìµœê·¼ì˜ ì„±ê³µ ë¡œì§ ì‚¬ìš©)
# ==============================================================================

file_path_str = r'/content/(ì›”) í–‰ì •êµ¬ì—­ë³„ ì•„íŒŒíŠ¸ë§¤ë§¤ê±°ë˜í˜„í™©.csv'
file_path = Path(file_path_str)

df = None
load_successful = False

for encoding_type in ['cp949', 'utf-8']:
    try:
        df = pd.read_csv(file_path, encoding=encoding_type, header=0)
        load_successful = True
        # print(f"** íŒŒì¼ ë¡œë“œ ì„±ê³µ ({encoding_type} ì¸ì½”ë”© ì ìš©).")
        break
    except Exception:
        pass

if not load_successful:
    print("\n[ì¹˜ëª…ì  ì˜¤ë¥˜] íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨. ì¸ì½”ë”© ë° íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
    exit()

# ==============================================================================
# 4. ë°ì´í„° ì „ì²˜ë¦¬ ë° ë¶„ì„ ê¸°ê°„ ë°ì´í„° ì¶”ì¶œ
# ==============================================================================

# ì»¬ëŸ¼ëª… ì •ë¦¬ (ê³µë°± -> ë°‘ì¤„)
df.columns = df.columns.str.replace(r'\s+', '_', regex=True).str.strip()
trade_cols_underscore = [col.replace(' ', '_') for col in analysis_month_names]

REGION_COL_KEY = 'ì§€ì—­í†µí•©'

# í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ
required_cols = [REGION_COL_KEY] + trade_cols_underscore
missing_cols = [col for col in required_cols if col not in df.columns]

if missing_cols:
    print(f"\n[ì¹˜ëª…ì  ì˜¤ë¥˜] ë¶„ì„ì— í•„ìš”í•œ ì›”ë³„ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. íŒŒì¼ì— {missing_cols} ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.")
    exit()

df_analysis = df[required_cols].copy()
df_analysis.columns = ['ì§€ì—­ëª…'] + analysis_month_names # ì»¬ëŸ¼ëª…ì„ ë³´ê¸° ì¢‹ê²Œ ë³µì›
trade_months = analysis_month_names # ì›”ë³„ ì»¬ëŸ¼ ì´ë¦„

# 'ì „êµ­' í–‰ ë° ê²°ì¸¡ê°’ ì œê±°
df_analysis = df_analysis[df_analysis['ì§€ì—­ëª…'].notna()]
df_analysis = df_analysis[~df_analysis['ì§€ì—­ëª…'].astype(str).str.contains('ì „êµ­')]

# ê±°ë˜ê±´ìˆ˜ ì»¬ëŸ¼ì„ ìˆ«ìí˜•ìœ¼ë¡œ ë³€í™˜ (ì‰¼í‘œ ë° ë”°ì˜´í‘œ ì œê±° í›„ ë³€í™˜)
for col in trade_months:
    df_analysis[col] = df_analysis[col].astype(str).str.replace(r'["\s,]', '', regex=True)

df_analysis[trade_months] = df_analysis[trade_months].apply(pd.to_numeric, errors='coerce')


# ==============================================================================
# 5. ì „ì›” ëŒ€ë¹„ ê±°ë˜ëŸ‰ ì¦ê°€ ë¹„ìœ¨ ê³„ì‚°
# ==============================================================================

# ê¸°ê°„ë³„ ì¦ê°€ ë¹„ìœ¨ (Percentage Change) ê³„ì‚°
df_pct_change = df_analysis[trade_months].pct_change(axis=1)

# ë¹„ìœ¨ ì»¬ëŸ¼ëª… ì •ì˜
pct_change_cols = []
for i in range(1, len(trade_months)):
    prev_month = trade_months[i-1]
    curr_month = trade_months[i]
    pct_change_col_name = f"{prev_month} ëŒ€ë¹„ {curr_month} ì¦ê°€ìœ¨ (%)"
    pct_change_cols.append(pct_change_col_name)

df_results = df_analysis[['ì§€ì—­ëª…']].copy()
# ë¹„ìœ¨ì„ %ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥ (ì²« ë²ˆì§¸ ì»¬ëŸ¼ì€ NaNì´ë¯€ë¡œ 1ë¶€í„° ì‹œì‘)
df_results[pct_change_cols] = df_pct_change.iloc[:, 1:].values * 100

# ==============================================================================
# 6. ìµœì¢… ì¶œë ¥: ê°€ì¥ ìµœê·¼ ì›” ê¸°ì¤€ TOP 10 ì„ ì • í›„, 3ê°œì›” ë°ì´í„° í‘œì‹œ
# ==============================================================================

# ê°€ì¥ ìµœê·¼ ì›”ì˜ ì¦ê°€ìœ¨ ì»¬ëŸ¼ì„ ê¸°ì¤€ìœ¼ë¡œ TOP 10 ì§€ì—­ ì„ ì •
recent_pct_col = pct_change_cols[-1]
top_10_results = df_results.nlargest(10, recent_pct_col)

# ìµœì¢… ì¶œë ¥ í¬ë§·íŒ…
for col in pct_change_cols:
    top_10_results[col] = top_10_results[col].map('{:,.2f}%'.format)

print("\n" + "=" * 80)
print(f"## ğŸ¥‡ {trade_months[-1]} ê¸°ì¤€ ì „ì›” ëŒ€ë¹„ ì¦ê°€ìœ¨ TOP 10 ì§€ì—­ ë¶„ì„ ê²°ê³¼")
print("-" * 80)
print(f"   (ì„ ì • ê¸°ì¤€: {recent_pct_col})")
print("=" * 80)

# ì§€ì—­ëª…ì„ ì¸ë±ìŠ¤ë¡œ ì„¤ì •í•˜ê³  ì¶œë ¥
print(top_10_results.set_index('ì§€ì—­ëª…'))

print("\n" + "=" * 80)
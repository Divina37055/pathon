# -*- coding: utf-8 -*-
"""ì•„íŒŒë§¤ê±°ë˜ëŸ‰ ì¦ê°€ìœ¨ì´ ë†’ì€ ì§€ì—­ ì°¾ê¸°

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ehIJGYAqPr4zJcvtmt2gyaAcZ9Ue_4uN
"""

import streamlit as st
import pandas as pd
from pathlib import Path
from datetime import datetime

# ==============================================================================
# 1. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì •ì˜: ì›” ê³„ì‚° ë° ì»¬ëŸ¼ëª… í˜•ì‹ ì§€ì •
# ==============================================================================

@st.cache_data
def get_month_string(year, month):
    """'YYYYë…„ Mì›”' í˜•íƒœì˜ ë¬¸ìì—´ì„ ë°˜í™˜ (íŒŒì¼ ì»¬ëŸ¼ëª…ê³¼ ì¼ì¹˜í•˜ë„ë¡ '0' ì œê±°)."""
    return f"{year}ë…„ {month}ì›”"

@st.cache_data
def get_previous_month(year, month):
    """ì…ë ¥ëœ ë…„/ì›”ì˜ ì´ì „ ë‹¬ì˜ ë…„/ì›”ì„ ê³„ì‚°í•˜ì—¬ ë°˜í™˜."""
    if month == 1:
        return year - 1, 12
    else:
        return year, month - 1

@st.cache_data
def get_analysis_months(target_year, target_month):
    """
    ë¶„ì„ì— í•„ìš”í•œ 4ê°œ ì›”(íƒ€ê²Ÿ ì›”ê³¼ ê·¸ ì´ì „ 3ê°œì›”)ì˜ ë…„/ì›” íŠœí”Œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    """
    month_list = []
    y, m = target_year, target_month

    # ì´ 4ê°œì˜ ì›”ì„ ì—­ìˆœìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤. (íƒ€ê²Ÿ ì›”ë¶€í„° ì‹œì‘)
    for _ in range(4):
        month_list.append((y, m))
        y, m = get_previous_month(y, m)

    return month_list[::-1] # ê°€ì¥ ì˜¤ë˜ëœ ë‹¬ë¶€í„° ìˆœì„œëŒ€ë¡œ ì •ë ¬í•˜ì—¬ ë°˜í™˜

# ==============================================================================
# 2. íŒŒì¼ ë¡œë“œ í•¨ìˆ˜ (Streamlit ì „ìš©)
# ==============================================================================

@st.cache_data
def load_data(uploaded_file):
    """ì—…ë¡œë“œëœ CSV íŒŒì¼ì„ ì½ì–´ DataFrameì„ ë°˜í™˜ (cp949, utf-8 ìˆœì°¨ ì‹œë„)."""
    if uploaded_file is None:
        return None

    df = None

    # íŒŒì¼ ë¡œë“œ ì‹œë„ (cp949ì™€ utf-8 ìˆœì°¨ ì‹œë„)
    for encoding_type in ['cp949', 'utf-8']:
        try:
            # BytesIOë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ëª¨ë¦¬ì—ì„œ ì§ì ‘ íŒŒì¼ ë¡œë“œ
            df = pd.read_csv(uploaded_file, encoding=encoding_type, header=0)

            # íŒŒì¼ ë¡œë“œ ì„±ê³µ ì‹œ, íŒŒì¼ í¬ì¸í„°ë¥¼ ë‹¤ì‹œ ì²˜ìŒìœ¼ë¡œ ëŒë ¤ ë‹¤ìŒ ì‹œë„ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ í•¨
            uploaded_file.seek(0)
            return df
        except Exception:
            # ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ ì¸ì½”ë”© ì‹œë„
            uploaded_file.seek(0)
            continue

    return None

# ==============================================================================
# 3. ë°ì´í„° ë¶„ì„ ë° ê²°ê³¼ ë°˜í™˜ í•¨ìˆ˜
# ==============================================================================

def run_analysis(df, input_year, input_month):
    """ì‹¤ì œ ë°ì´í„° ë¶„ì„ ë¡œì§ì„ ìˆ˜í–‰í•˜ê³  ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""

    analysis_months_tuple = get_analysis_months(input_year, input_month)
    analysis_month_names = [get_month_string(y, m) for y, m in analysis_months_tuple]

    # ì»¬ëŸ¼ëª… ì •ë¦¬ (ê³µë°± -> ë°‘ì¤„)
    df.columns = df.columns.str.replace(r'\s+', '_', regex=True).str.strip()
    trade_cols_underscore = [col.replace(' ', '_') for col in analysis_month_names]

    REGION_COL_KEY = 'ì§€ì—­í†µí•©'

    if REGION_COL_KEY not in df.columns:
        return f"[ì˜¤ë¥˜] íŒŒì¼ì— í•„ìˆ˜ ì»¬ëŸ¼ ('{REGION_COL_KEY}')ì´ ì—†ìŠµë‹ˆë‹¤.", None

    # í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ
    required_cols = [REGION_COL_KEY] + trade_cols_underscore
    missing_cols = [col for col in required_cols if col not in df.columns]

    if missing_cols:
        return f"[ì˜¤ë¥˜] ë¶„ì„ì— í•„ìš”í•œ ì›”ë³„ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. íŒŒì¼ì— {missing_cols} ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤. (í˜„ì¬ íŒŒì¼ ì»¬ëŸ¼: {list(df.columns)})", None

    df_analysis = df[required_cols].copy()
    df_analysis.columns = ['ì§€ì—­ëª…'] + analysis_month_names
    trade_months = analysis_month_names

    # 'ì „êµ­' í–‰ ë° ê²°ì¸¡ê°’ ì œê±°
    df_analysis = df_analysis[df_analysis['ì§€ì—­ëª…'].notna()]
    df_analysis = df_analysis[~df_analysis['ì§€ì—­ëª…'].astype(str).str.contains('ì „êµ­')]

    # ê±°ë˜ê±´ìˆ˜ ì»¬ëŸ¼ì„ ìˆ«ìí˜•ìœ¼ë¡œ ë³€í™˜
    for col in trade_months:
        df_analysis[col] = df_analysis[col].astype(str).str.replace(r'["\s,]', '', regex=True)

    df_analysis[trade_months] = df_analysis[trade_months].apply(pd.to_numeric, errors='coerce')

    # ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
    if df_analysis[trade_months].isnull().all().all():
        return "[ì˜¤ë¥˜] ì„ íƒëœ ê¸°ê°„ì˜ ê±°ë˜ëŸ‰ ë°ì´í„°ê°€ ëª¨ë‘ ë¹„ì–´ìˆê±°ë‚˜ ìˆ«ì í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", None

    # ì „ì›” ëŒ€ë¹„ ê±°ë˜ëŸ‰ ì¦ê°€ ë¹„ìœ¨ ê³„ì‚°
    df_pct_change = df_analysis[trade_months].pct_change(axis=1)

    # ë¹„ìœ¨ ì»¬ëŸ¼ëª… ì •ì˜
    pct_change_cols = []
    for i in range(1, len(trade_months)):
        prev_month = trade_months[i-1]
        curr_month = trade_months[i]
        pct_change_col_name = f"{prev_month} ëŒ€ë¹„ {curr_month} ì¦ê°€ìœ¨ (%)"
        pct_change_cols.append(pct_change_col_name)

    df_results = df_analysis[['ì§€ì—­ëª…']].copy()
    df_results[pct_change_cols] = df_pct_change.iloc[:, 1:].values * 100

    # ê°€ì¥ ìµœê·¼ ì›”ì˜ ì¦ê°€ìœ¨ ì»¬ëŸ¼ì„ ê¸°ì¤€ìœ¼ë¡œ TOP 10 ì§€ì—­ ì„ ì •
    recent_pct_col = pct_change_cols[-1]

    # NaN ê°’ì€ 0ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ ìˆœìœ„ ì„ ì •ì—ì„œ ì œì™¸ë˜ê±°ë‚˜ í•˜ìœ„ì— ìœ„ì¹˜í•˜ë„ë¡ í•¨
    top_10_results = df_results.fillna(0).nlargest(10, recent_pct_col)

    # ìµœì¢… ì¶œë ¥ í¬ë§·íŒ… (ê²°ì¸¡ê°’ì€ '-'ë¡œ í‘œì‹œ)
    for col in pct_change_cols:
        top_10_results[col] = top_10_results[col].map(lambda x: '{:,.2f}%'.format(x) if x != 0 else '-')

    return None, top_10_results.set_index('ì§€ì—­ëª…')


# ==============================================================================
# 4. Streamlit ë©”ì¸ ì•± ì‹¤í–‰
# ==============================================================================

def main():
    st.set_page_config(layout="wide", page_title="ì•„íŒŒíŠ¸ ë§¤ë§¤ ê±°ë˜ ë¶„ì„ê¸°")
    st.title("ğŸ¡ ì•„íŒŒíŠ¸ ë§¤ë§¤ ê±°ë˜ëŸ‰ ë³€í™” ë¶„ì„ê¸°")
    st.markdown("---")

    # -------------------
    # 4-1. ì‚¬ì´ë“œë°” (ì‚¬ìš©ì ì…ë ¥)
    # -------------------
    st.sidebar.header("1. ë°ì´í„° íŒŒì¼ ì—…ë¡œë“œ")
    uploaded_file = st.sidebar.file_uploader(
        "íŒŒì¼ (CSV)ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.",
        type="csv",
        help="íŒŒì¼ ì´ë¦„ì€ '(ì›”) í–‰ì •êµ¬ì—­ë³„ ì•„íŒŒíŠ¸ë§¤ë§¤ê±°ë˜í˜„í™©.csv' êµ¬ì¡°ì™€ ìœ ì‚¬í•´ì•¼ í•©ë‹ˆë‹¤."
    )

    st.sidebar.header("2. ë¶„ì„ ê¸°ì¤€ ì›” ì„¤ì •")
    current_year = datetime.now().year

    # ë…„ë„ ì…ë ¥
    input_year = st.sidebar.number_input(
        "ê¸°ì¤€ ë…„ë„ (YYYY)",
        min_value=2010,
        max_value=current_year + 1,
        value=current_year,
        step=1
    )

    # ì›” ì…ë ¥
    input_month = st.sidebar.selectbox(
        "ê¸°ì¤€ ì›” (MM)",
        options=range(1, 13),
        index=datetime.now().month - 1
    )

    # -------------------
    # 4-2. ë°ì´í„° ë¡œë“œ ë° ë¶„ì„ ì‹¤í–‰
    # -------------------
    if uploaded_file is None:
        st.info("ì¢Œì¸¡ ì‚¬ì´ë“œë°”ì— ë¶„ì„í•  CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
        return

    # ë°ì´í„° ë¡œë“œ
    df = load_data(uploaded_file)

    if df is None:
        st.error("íŒŒì¼ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ì´ ìœ íš¨í•œ CSV í˜•ì‹ì¸ì§€, ì¸ì½”ë”© ë¬¸ì œ(cp949, utf-8)ê°€ ì—†ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
        return

    # ë¶„ì„ ì‹¤í–‰
    with st.spinner("ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
        error_message, top_10_results_df = run_analysis(df, input_year, input_month)

    # -------------------
    # 4-3. ê²°ê³¼ ì¶œë ¥
    # -------------------
    if error_message:
        st.error(error_message)
    elif top_10_results_df is not None:

        # ë¶„ì„ ê¸°ê°„ ì •ë³´
        analysis_months_tuple = get_analysis_months(input_year, input_month)
        analysis_month_names = [get_month_string(y, m) for y, m in analysis_months_tuple]

        recent_month = analysis_month_names[-1]

        st.header(f"ğŸ¥‡ {recent_month} ê¸°ì¤€ ì „ì›” ëŒ€ë¹„ ì¦ê°€ìœ¨ TOP 10 ì§€ì—­ ë¶„ì„ ê²°ê³¼")
        st.subheader(f"ğŸ“… ë¶„ì„ ê¸°ê°„: {analysis_month_names[0]} ~ {recent_month} (4ê°œì›” ë°ì´í„° ê¸°ì¤€)")
        st.caption(f"ì„ ì • ê¸°ì¤€: {top_10_results_df.columns[-1]} (ê°€ì¥ ìµœê·¼ ì›”ì˜ ì „ì›” ëŒ€ë¹„ ì¦ê°€ìœ¨)")
        st.markdown("---")

        # ê²°ê³¼ ë°ì´í„°í”„ë ˆì„ ì¶œë ¥
        st.dataframe(
            top_10_results_df,
            use_container_width=True
        )

if __name__ == "__main__":
    main()
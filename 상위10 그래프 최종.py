# -*- coding: utf-8 -*-
"""Untitled0.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/12ZQFLZ22mJQ5relXDhQCKGJ8y8ZAceYE
"""

# -*- coding: utf-8 -*-
"""ì•„íŒŒë§¤ê±°ë˜ëŸ‰ ì¦ê°€ìœ¨ì´ ë†’ì€ ì§€ì—­ ì°¾ê¸°
Automatically generated by Colab.
Original file is located at
    https://colab.research.google.com/drive/1ehIJGYAqPr4zJcvtmt2gyaAcZ9Ue_4uN
"""
import streamlit as st
import pandas as pd
from pathlib import Path
from datetime import datetime

# ==============================================================================
# 1. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì •ì˜: ì›” ê³„ì‚° ë° ì»¬ëŸ¼ëª… í˜•ì‹ ì§€ì •
# ==============================================================================
@st.cache_data
def get_month_string(year, month):
    """'YYYYë…„ Mì›”' í˜•íƒœì˜ ë¬¸ìì—´ì„ ë°˜í™˜ (íŒŒì¼ ì»¬ëŸ¼ëª…ê³¼ ì¼ì¹˜í•˜ë„ë¡ '0' ì œê±°)."""
    return f"{year}ë…„ {month}ì›”"

@st.cache_data
def get_previous_month(year, month):
    """ì…ë ¥ëœ ë…„/ì›”ì˜ ì´ì „ ë‹¬ì˜ ë…„/ì›”ì„ ê³„ì‚°í•˜ì—¬ ë°˜í™˜."""
    if month == 1:
        return year - 1, 12
    else:
        return year, month - 1

@st.cache_data
def get_analysis_months(target_year, target_month):
    """
    ë¶„ì„ì— í•„ìš”í•œ 4ê°œ ì›”(íƒ€ê²Ÿ ì›”ê³¼ ê·¸ ì´ì „ 3ê°œì›”)ì˜ ë…„/ì›” íŠœí”Œ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    """
    month_list = []
    y, m = target_year, target_month
    # ì´ 4ê°œì˜ ì›”ì„ ì—­ìˆœìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤. (íƒ€ê²Ÿ ì›”ë¶€í„° ì‹œì‘)
    for _ in range(4):
        month_list.append((y, m))
        y, m = get_previous_month(y, m)
    return month_list[::-1]  # ê°€ì¥ ì˜¤ë˜ëœ ë‹¬ë¶€í„° ìˆœì„œëŒ€ë¡œ ì •ë ¬í•˜ì—¬ ë°˜í™˜

# ==============================================================================
# 2. íŒŒì¼ ë¡œë“œ í•¨ìˆ˜ (Streamlit ì „ìš©)
# ==============================================================================
@st.cache_data
def load_data_from_github():
    """GitHubì—ì„œ CSV íŒŒì¼ì„ ìë™ìœ¼ë¡œ ë¡œë“œí•©ë‹ˆë‹¤."""
    github_url = "https://raw.githubusercontent.com/divina37055/pathon/main/(ì›”) í–‰ì •êµ¬ì—­ë³„ ì•„íŒŒíŠ¸ê±°ë˜ëŸ‰ì§€í‘œ.csv"

    try:
        # GitHub raw URLì—ì„œ ì§ì ‘ ì½ê¸°
        for encoding_type in ['cp949', 'utf-8']:
            try:
                df = pd.read_csv(github_url, encoding=encoding_type, header=0)
                return df, None
            except Exception:
                continue
        return None, "íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸ì½”ë”© ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    except Exception as e:
        return None, f"GitHubì—ì„œ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"

@st.cache_data
def load_data(uploaded_file):
    """ì—…ë¡œë“œëœ CSV íŒŒì¼ì„ ì½ì–´ DataFrameì„ ë°˜í™˜ (cp949, utf-8 ìˆœì°¨ ì‹œë„)."""
    if uploaded_file is None:
        return None
    df = None
    # íŒŒì¼ ë¡œë“œ ì‹œë„ (cp949ì™€ utf-8 ìˆœì°¨ ì‹œë„)
    for encoding_type in ['cp949', 'utf-8']:
        try:
            # BytesIOë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ëª¨ë¦¬ì—ì„œ ì§ì ‘ íŒŒì¼ ë¡œë“œ
            df = pd.read_csv(uploaded_file, encoding=encoding_type, header=0)
            # íŒŒì¼ ë¡œë“œ ì„±ê³µ ì‹œ, íŒŒì¼ í¬ì¸í„°ë¥¼ ë‹¤ì‹œ ì²˜ìŒìœ¼ë¡œ ëŒë ¤ ë‹¤ìŒ ì‹œë„ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ í•¨
            uploaded_file.seek(0)
            return df
        except Exception:
            # ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ ì¸ì½”ë”© ì‹œë„
            uploaded_file.seek(0)
            continue
    return None

# ==============================================================================
# 3. ë°ì´í„° ë¶„ì„ ë° ê²°ê³¼ ë°˜í™˜ í•¨ìˆ˜
# ==============================================================================
def run_analysis(df, input_year, input_month):
    """ì‹¤ì œ ë°ì´í„° ë¶„ì„ ë¡œì§ì„ ìˆ˜í–‰í•˜ê³  ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
    # ë‚ ì§œ ë²”ìœ„ ê²€ì¦ (2020ë…„ 1ì›” ~ 2025ë…„ 8ì›”)
    if input_year < 2020 or input_year > 2025:
        return "[ì˜¤ë¥˜] ë¶„ì„ ê°€ëŠ¥í•œ ê¸°ê°„ì€ 2020ë…„ 1ì›”ë¶€í„° 2025ë…„ 8ì›”ê¹Œì§€ì…ë‹ˆë‹¤.", None, None
    if input_year == 2020 and input_month < 1:
        return "[ì˜¤ë¥˜] 2020ë…„ì€ 1ì›”ë¶€í„° ë¶„ì„ ê°€ëŠ¥í•©ë‹ˆë‹¤.", None, None
    if input_year == 2025 and input_month > 8:
        return "[ì˜¤ë¥˜] 2025ë…„ì€ 8ì›”ê¹Œì§€ë§Œ ë¶„ì„ ê°€ëŠ¥í•©ë‹ˆë‹¤.", None, None

    analysis_months_tuple = get_analysis_months(input_year, input_month)
    analysis_month_names = [get_month_string(y, m) for y, m in analysis_months_tuple]

    # ì»¬ëŸ¼ëª… ì •ë¦¬ (ê³µë°± -> ë°‘ì¤„)
    df.columns = df.columns.str.replace(r'\s+', '_', regex=True).str.strip()
    trade_cols_underscore = [col.replace(' ', '_') for col in analysis_month_names]

    REGION_COL_KEY = 'ì§€ì—­í†µí•©'
    if REGION_COL_KEY not in df.columns:
        return f"[ì˜¤ë¥˜] íŒŒì¼ì— í•„ìˆ˜ ì»¬ëŸ¼ ('{REGION_COL_KEY}')ì´ ì—†ìŠµë‹ˆë‹¤.", None, None

    # í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ
    required_cols = [REGION_COL_KEY] + trade_cols_underscore
    missing_cols = [col for col in required_cols if col not in df.columns]
    if missing_cols:
        return f"[ì˜¤ë¥˜] ë¶„ì„ì— í•„ìš”í•œ ì›”ë³„ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. íŒŒì¼ì— {missing_cols} ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤. (í˜„ì¬ íŒŒì¼ ì»¬ëŸ¼: {list(df.columns)})", None, None

    df_analysis = df[required_cols].copy()
    df_analysis.columns = ['ì§€ì—­ëª…'] + analysis_month_names
    trade_months = analysis_month_names

    # 'ì „êµ­' í–‰ ë° ê²°ì¸¡ê°’ ì œê±°
    df_analysis = df_analysis[df_analysis['ì§€ì—­ëª…'].notna()]
    df_analysis = df_analysis[~df_analysis['ì§€ì—­ëª…'].astype(str).str.contains('ì „êµ­')]

    # ê±°ë˜ê±´ìˆ˜ ì»¬ëŸ¼ì„ ìˆ«ìí˜•ìœ¼ë¡œ ë³€í™˜
    for col in trade_months:
        df_analysis[col] = df_analysis[col].astype(str).str.replace(r'["\s,]', '', regex=True)
    df_analysis[trade_months] = df_analysis[trade_months].apply(pd.to_numeric, errors='coerce')

    # ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
    if df_analysis[trade_months].isnull().all().all():
        return "[ì˜¤ë¥˜] ì„ íƒëœ ê¸°ê°„ì˜ ê±°ë˜ëŸ‰ ë°ì´í„°ê°€ ëª¨ë‘ ë¹„ì–´ìˆê±°ë‚˜ ìˆ«ì í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", None, None

    # ì „ì›” ëŒ€ë¹„ ê±°ë˜ëŸ‰ ì¦ê°€ ë¹„ìœ¨ ê³„ì‚°
    df_pct_change = df_analysis[trade_months].pct_change(axis=1)

    # ë¹„ìœ¨ ì»¬ëŸ¼ëª… ì •ì˜
    pct_change_cols = []
    for i in range(1, len(trade_months)):
        prev_month = trade_months[i-1]
        curr_month = trade_months[i]
        pct_change_col_name = f"{prev_month} ëŒ€ë¹„ {curr_month} ì¦ê°€ìœ¨ (%)"
        pct_change_cols.append(pct_change_col_name)

    df_results = df_analysis[['ì§€ì—­ëª…']].copy()
    df_results[pct_change_cols] = df_pct_change.iloc[:, 1:].values * 100

    # ê° ì›”ë³„ ê±°ë˜ê±´ìˆ˜ ì¶”ê°€ (4ê°œì›” ì „ë¶€í„° ì…ë ¥ì›”ê¹Œì§€)
    for month in trade_months:
        df_results[f'{month} ê±°ë˜ê±´ìˆ˜'] = df_analysis[month]

    # í•„í„°ë§ ì¡°ê±´ 1: ìµœê·¼ 3ê°œì›” ì¤‘ ê±°ë˜ëŸ‰ì´ 0ì¸ ê°’ì´ ìˆëŠ” ì§€ì—­ ì œì™¸
    recent_3_months = trade_months[-3:]  # ìµœê·¼ 3ê°œì›”
    mask_no_zero = (df_analysis[recent_3_months] != 0).all(axis=1)

    # í•„í„°ë§ ì¡°ê±´ 2: ì…ë ¥ì›”(ê°€ì¥ ìµœê·¼ ì›”) ê±°ë˜ëŸ‰ì´ ìƒìœ„ 30%ì— í•´ë‹¹í•˜ëŠ” ì§€ì—­ë§Œ ì„ íƒ
    target_month = trade_months[-1]  # ì…ë ¥ì›” (ê°€ì¥ ìµœê·¼ ì›”)
    percentile_70 = df_analysis[target_month].quantile(0.70)  # ìƒìœ„ 30% ê¸°ì¤€ê°’
    mask_top_30_pct = df_analysis[target_month] >= percentile_70

    # ë‘ ì¡°ê±´ì„ ëª¨ë‘ ë§Œì¡±í•˜ëŠ” ì§€ì—­ë§Œ í•„í„°ë§
    valid_indices = mask_no_zero & mask_top_30_pct
    df_results_filtered = df_results[valid_indices].copy()

    # í•„í„°ë§ëœ ê²°ê³¼ì—ì„œ ê°€ì¥ ìµœê·¼ ì›”ì˜ ì¦ê°€ìœ¨ ê¸°ì¤€ TOP 10 ì„ ì •
    recent_pct_col = pct_change_cols[-1]

    # í•„í„°ë§ í›„ ë°ì´í„°ê°€ ì¶©ë¶„í•œì§€ í™•ì¸
    if len(df_results_filtered) < 1:
        return "[ì˜¤ë¥˜] í•„í„°ë§ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì§€ì—­ì´ ì—†ìŠµë‹ˆë‹¤. (ìµœê·¼ 3ê°œì›” ê±°ë˜ëŸ‰ì´ ëª¨ë‘ 0ë³´ë‹¤ í¬ê³ , ì…ë ¥ì›” ê±°ë˜ëŸ‰ì´ ìƒìœ„ 30%ì— í•´ë‹¹í•˜ëŠ” ì§€ì—­)", None, None

    # TOP 10 ì„ ì • (í•„í„°ë§ëœ ë°ì´í„° ì¤‘ì—ì„œ, ë°ì´í„°ê°€ 10ê°œ ë¯¸ë§Œì´ë©´ ê°€ëŠ¥í•œ ë§Œí¼ë§Œ ì„ ì •)
    top_n = min(10, len(df_results_filtered))
    top_10_results = df_results_filtered.fillna(0).nlargest(top_n, recent_pct_col)

    # ìµœì¢… ì¶œë ¥ í¬ë§·íŒ… ë° ì»¬ëŸ¼ ìˆœì„œ ì¬ì •ë ¬
    # ìˆœì„œ: ì§€ì—­ëª…, [3ê°œì›”ì „ ì¦ê°€ìœ¨, 3ê°œì›”ì „ ê±°ë˜ê±´ìˆ˜], [2ê°œì›”ì „ ì¦ê°€ìœ¨, 2ê°œì›”ì „ ê±°ë˜ê±´ìˆ˜],
    #       [ì „ì›” ì¦ê°€ìœ¨, ì „ì›” ê±°ë˜ê±´ìˆ˜], [ë‹¹ì›” ê±°ë˜ê±´ìˆ˜]

    final_cols = ['ì§€ì—­ëª…']
    renamed_cols = {'ì§€ì—­ëª…': 'ì§€ì—­ëª…'}

    # ì»¬ëŸ¼ëª… ë§¤í•‘ ì •ì˜
    period_names = ['3ê°œì›”ì „', '2ê°œì›”ì „', 'ì „ì›”']

    # 3ê°œì›” ì „ë¶€í„° ìˆœì„œëŒ€ë¡œ (ì¦ê°€ìœ¨, ê±°ë˜ê±´ìˆ˜) ìŒìœ¼ë¡œ ì¶”ê°€
    for i in range(1, len(trade_months)):
        month = trade_months[i]
        pct_col = pct_change_cols[i-1]
        count_col = f'{month} ê±°ë˜ê±´ìˆ˜'

        # ì¦ê°€ìœ¨ í¬ë§·íŒ…
        top_10_results[pct_col] = top_10_results[pct_col].map(
            lambda x: '{:,.2f}%'.format(x) if pd.notna(x) and x != 0 else '-'
        )

        # ê±°ë˜ê±´ìˆ˜ í¬ë§·íŒ…
        top_10_results[count_col] = top_10_results[count_col].map(
            lambda x: '{:,.0f}ê±´'.format(x) if pd.notna(x) and x != 0 else '-'
        )

        # ì»¬ëŸ¼ëª… ë³€ê²½ ë§¤í•‘ ì¶”ê°€
        if i <= 3:  # 3ê°œì›” ì „ë¶€í„° ì „ì›”ê¹Œì§€
            period_name = period_names[i-1]
            renamed_cols[pct_col] = f'{period_name} ì¦ê°€ìœ¨'
            if i < 3:  # 3ê°œì›”ì „, 2ê°œì›”ì „
                renamed_cols[count_col] = f'{period_name} ê±°ë˜ê±´ìˆ˜'
            else:  # ì „ì›”
                renamed_cols[count_col] = 'ì „ì›” ê±°ë˜ê±´ìˆ˜'

        final_cols.extend([pct_col, count_col])

    # ë‹¹ì›” ê±°ë˜ê±´ìˆ˜ (ë§ˆì§€ë§‰ ì›”ì˜ ê±°ë˜ê±´ìˆ˜)
    last_month_count = f'{trade_months[-1]} ê±°ë˜ê±´ìˆ˜'
    renamed_cols[last_month_count] = 'ë‹¹ì›” ê±°ë˜ê±´ìˆ˜'

    top_10_results = top_10_results[final_cols]

    # ì»¬ëŸ¼ëª… ë³€ê²½
    top_10_results = top_10_results.rename(columns=renamed_cols)

    # ê·¸ë˜í”„ìš© ì›ë³¸ ë°ì´í„° ë°˜í™˜ (í¬ë§·íŒ… ì „ ë°ì´í„°)
    graph_data = df_analysis[valid_indices].nlargest(top_n, target_month, keep='first')
    graph_data = graph_data[['ì§€ì—­ëª…'] + trade_months].copy()

    return None, top_10_results, graph_data

# ==============================================================================
# 4. Streamlit ë©”ì¸ ì•± ì‹¤í–‰
# ==============================================================================
def main():
    st.set_page_config(layout="wide", page_title="ì•„íŒŒíŠ¸ ë§¤ë§¤ ê±°ë˜ ë¶„ì„ê¸°")
    st.title("ğŸ¡ ì•„íŒŒíŠ¸ ë§¤ë§¤ ê±°ë˜ëŸ‰ ë³€í™” ë¶„ì„ê¸°")
    st.caption("ğŸ“… ë¶„ì„ ê°€ëŠ¥ ê¸°ê°„: 2020ë…„ 1ì›” ~ 2025ë…„ 8ì›”")
    st.markdown("---")

    # -------------------
    # 4-1. ì‚¬ì´ë“œë°” (ì‚¬ìš©ì ì…ë ¥)
    # -------------------
    st.sidebar.header("1. ë°ì´í„° ì†ŒìŠ¤ ì„ íƒ")

    data_source = st.sidebar.radio(
        "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë°©ì‹",
        options=["GitHubì—ì„œ ìë™ ë¡œë“œ", "íŒŒì¼ ì§ì ‘ ì—…ë¡œë“œ"],
        index=0,
        help="ê¸°ë³¸ì ìœ¼ë¡œ GitHubì˜ ìµœì‹  ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
    )

    uploaded_file = None
    if data_source == "íŒŒì¼ ì§ì ‘ ì—…ë¡œë“œ":
        uploaded_file = st.sidebar.file_uploader(
            "íŒŒì¼ (CSV)ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.",
            type="csv",
            help="íŒŒì¼ ì´ë¦„ì€ '(ì›”) í–‰ì •êµ¬ì—­ë³„ ì•„íŒŒíŠ¸ë§¤ë§¤ê±°ë˜í˜„í™©.csv' êµ¬ì¡°ì™€ ìœ ì‚¬í•´ì•¼ í•©ë‹ˆë‹¤."
        )

    st.sidebar.header("2. ë¶„ì„ ê¸°ì¤€ ì›” ì„¤ì •")

    # ë…„ë„ ì…ë ¥ (2020ë…„ 1ì›” ~ 2025ë…„ 8ì›”)
    input_year = st.sidebar.number_input(
        "ê¸°ì¤€ ë…„ë„ (YYYY)",
        min_value=2020,
        max_value=2025,
        value=2025,
        step=1,
        help="2020ë…„ 1ì›”ë¶€í„° 2025ë…„ 8ì›”ê¹Œì§€ ë¶„ì„ ê°€ëŠ¥í•©ë‹ˆë‹¤."
    )

    # ì›” ì…ë ¥ (ë…„ë„ì— ë”°ë¼ ì œí•œ)
    if input_year == 2020:
        # 2020ë…„ì€ 1ì›”ë¶€í„°ë§Œ ê°€ëŠ¥
        available_months = list(range(1, 13))
        default_month = 0  # 1ì›”
    elif input_year == 2025:
        # 2025ë…„ì€ 8ì›”ê¹Œì§€ë§Œ ê°€ëŠ¥
        available_months = list(range(1, 9))
        default_month = min(7, len(available_months) - 1)  # 8ì›” ë˜ëŠ” ë§ˆì§€ë§‰ ì›”
    else:
        # 2021~2024ë…„ì€ ì „ì²´ ì›” ê°€ëŠ¥
        available_months = list(range(1, 13))
        default_month = 0

    input_month = st.sidebar.selectbox(
        "ê¸°ì¤€ ì›” (MM)",
        options=available_months,
        index=default_month,
        help="ì„ íƒí•œ ë…„ë„ì— ë”°ë¼ ë¶„ì„ ê°€ëŠ¥í•œ ì›”ì´ ì œí•œë©ë‹ˆë‹¤."
    )

    # -------------------
    # 4-2. ë°ì´í„° ë¡œë“œ ë° ë¶„ì„ ì‹¤í–‰
    # -------------------
    df = None

    if data_source == "GitHubì—ì„œ ìë™ ë¡œë“œ":
        with st.spinner("GitHubì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."):
            df, error = load_data_from_github()
            if error:
                st.error(error)
                st.info("ğŸ’¡ íŒŒì¼ì„ ì§ì ‘ ì—…ë¡œë“œí•˜ë ¤ë©´ ì‚¬ì´ë“œë°”ì—ì„œ 'íŒŒì¼ ì§ì ‘ ì—…ë¡œë“œ'ë¥¼ ì„ íƒí•˜ì„¸ìš”.")
                return
            else:
                st.success("âœ… GitHubì—ì„œ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!")
    else:
        if uploaded_file is None:
            st.info("ì¢Œì¸¡ ì‚¬ì´ë“œë°”ì— ë¶„ì„í•  CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
            return

        # ë°ì´í„° ë¡œë“œ
        df = load_data(uploaded_file)
        if df is None:
            st.error("íŒŒì¼ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ì´ ìœ íš¨í•œ CSV í˜•ì‹ì¸ì§€, ì¸ì½”ë”© ë¬¸ì œ(cp949, utf-8)ê°€ ì—†ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
            return

    # ë¶„ì„ ì‹¤í–‰
    with st.spinner("ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
        error_message, top_10_results_df, graph_data = run_analysis(df, input_year, input_month)

    # -------------------
    # 4-3. ê²°ê³¼ ì¶œë ¥
    # -------------------
    if error_message:
        st.error(error_message)
    elif top_10_results_df is not None:
        # ë¶„ì„ ê¸°ê°„ ì •ë³´
        analysis_months_tuple = get_analysis_months(input_year, input_month)
        analysis_month_names = [get_month_string(y, m) for y, m in analysis_months_tuple]
        recent_month = analysis_month_names[-1]

        st.header(f"ğŸ¥‡ {recent_month} ê¸°ì¤€ ì „ì›” ëŒ€ë¹„ ì¦ê°€ìœ¨ TOP 10 ì§€ì—­ ë¶„ì„ ê²°ê³¼")
        st.subheader(f"ğŸ“… ë¶„ì„ ê¸°ê°„: {analysis_month_names[0]} ~ {recent_month} (4ê°œì›” ë°ì´í„° ê¸°ì¤€)")

        # í•„í„°ë§ ì¡°ê±´ ì„¤ëª…
        st.info(f"""
        **ğŸ“Œ í•„í„°ë§ ì¡°ê±´:**
        - âœ… ìµœê·¼ 3ê°œì›”({analysis_month_names[-3]} ~ {recent_month}) ê±°ë˜ëŸ‰ì´ ëª¨ë‘ 0ë³´ë‹¤ í¼
        - âœ… {recent_month} ê±°ë˜ëŸ‰ì´ ì „ì²´ ì§€ì—­ ì¤‘ ìƒìœ„ 30%ì— í•´ë‹¹
        - ğŸ“Š ì´ {len(top_10_results_df)}ê°œ ì§€ì—­ì´ ì¡°ê±´ì„ ë§Œì¡±í•˜ì—¬ ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤.
        """)

        st.caption(f"ğŸ’¡ ê° ì›”ë³„ë¡œ 'ì „ì›” ëŒ€ë¹„ ì¦ê°€ìœ¨'ê³¼ 'í•´ë‹¹ ì›” ê±°ë˜ê±´ìˆ˜'ë¥¼ í•¨ê»˜ í‘œì‹œí•©ë‹ˆë‹¤.")
        st.markdown("---")

        # ê²°ê³¼ ë°ì´í„°í”„ë ˆì„ ì¶œë ¥ (ì§€ì—­ëª…ì„ ì¸ë±ìŠ¤ë¡œ ì„¤ì •)
        st.dataframe(
            top_10_results_df.set_index('ì§€ì—­ëª…'),
            use_container_width=True
        )

        st.markdown("---")

        # ê·¸ë˜í”„ í‘œì‹œ ë²„íŠ¼
        col1, col2 = st.columns(2)

        with col1:
            show_inline_graph = st.button("ğŸ“Š ê±°ë˜ê±´ìˆ˜ ë³€ë™ ê·¸ë˜í”„ ë³´ê¸°", use_container_width=True, type="primary")

        with col2:
            show_popup_graph = st.button("ğŸ“ˆ ê±°ë˜ê±´ìˆ˜ ë³€ë™ ê·¸ë˜í”„ (í™•ëŒ€)", use_container_width=True)

        # ì¸ë¼ì¸ ê·¸ë˜í”„ í‘œì‹œ
        if show_inline_graph:
            st.subheader("ğŸ“Š ì§€ì—­ë³„ ê±°ë˜ê±´ìˆ˜ ë³€ë™ ì¶”ì´")

            import plotly.graph_objects as go

            fig = go.Figure()

            # ê° ì§€ì—­ë³„ë¡œ ë¼ì¸ ì¶”ê°€
            for idx, row in graph_data.iterrows():
                region_name = row['ì§€ì—­ëª…']
                values = row[analysis_month_names].values

                fig.add_trace(go.Scatter(
                    x=analysis_month_names,
                    y=values,
                    mode='lines+markers',
                    name=region_name,
                    line=dict(width=2),
                    marker=dict(size=8)
                ))

            fig.update_layout(
                title=f"{recent_month} ê¸°ì¤€ TOP 10 ì§€ì—­ ê±°ë˜ê±´ìˆ˜ ë³€ë™",
                xaxis_title="ê¸°ê°„",
                yaxis_title="ê±°ë˜ê±´ìˆ˜ (ê±´)",
                hovermode='x unified',
                legend=dict(
                    orientation="v",
                    yanchor="top",
                    y=1,
                    xanchor="left",
                    x=1.02
                ),
                height=500
            )

            st.plotly_chart(fig, use_container_width=True)

        # íŒì—…(í™•ëŒ€) ê·¸ë˜í”„ í‘œì‹œ
        if show_popup_graph:
            import plotly.graph_objects as go

            fig = go.Figure()

            # ê° ì§€ì—­ë³„ë¡œ ë¼ì¸ ì¶”ê°€
            for idx, row in graph_data.iterrows():
                region_name = row['ì§€ì—­ëª…']
                values = row[analysis_month_names].values

                fig.add_trace(go.Scatter(
                    x=analysis_month_names,
                    y=values,
                    mode='lines+markers',
                    name=region_name,
                    line=dict(width=3),
                    marker=dict(size=10)
                ))

            fig.update_layout(
                title=dict(
                    text=f"{recent_month} ê¸°ì¤€ TOP 10 ì§€ì—­ ê±°ë˜ê±´ìˆ˜ ë³€ë™",
                    font=dict(size=24)
                ),
                xaxis_title="ê¸°ê°„",
                yaxis_title="ê±°ë˜ê±´ìˆ˜ (ê±´)",
                hovermode='x unified',
                legend=dict(
                    orientation="v",
                    yanchor="top",
                    y=1,
                    xanchor="left",
                    x=1.02,
                    font=dict(size=14)
                ),
                height=700,
                width=1200
            )

            # ë‹¤ì´ì–¼ë¡œê·¸ ìŠ¤íƒ€ì¼ë¡œ í‘œì‹œ
            with st.container():
                st.markdown("### ğŸ“ˆ ê±°ë˜ê±´ìˆ˜ ë³€ë™ ê·¸ë˜í”„ (í™•ëŒ€ ë³´ê¸°)")
                st.plotly_chart(fig, use_container_width=False)

if __name__ == "__main__":
    main()